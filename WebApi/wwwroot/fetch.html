<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>EventSource Demo</title>
</head>
<body>
    <label for="message">Message:</label>
    <input type="text" id="message" name="message" />
    <button id="fetchStream">Fetch Stream</button>

    <script>
        /**
         * 将服务端格返回字符串尝试格式化为json
         * @param {String} str
         * @returns
         */
        const parser = (str) => {
            if (typeof str !== 'string') {
                return str;
            }
            try {
                return JSON.parse(str.substring(6));
            } catch (error) {
                return str;
            }
        };

        /**
         * 将Uint8Array转换为字符串
         * @param {Uint8Array} fileData
         * @returns
         */
        const Uint8ArrayToString = (fileData) => {
            const utf8 = Array.from(fileData)
                .map((item) => String.fromCharCode(item))
                .join('');

            return decodeURIComponent(escape(utf8));
        };

        /**
         * 基于fetch/ReadableStream 自定义封装的fetch请求
         * @param {*} url 请求链接
         * @param {*} params
         * @returns
         */
        const fetchStream = (url, params) => {
            const { onmessage, onclose, ...otherParams } = params;

            const push = async (controller, reader) => {
                const { value, done } = await reader.read();
                if (done) {
                    controller.close();
                    onclose?.();
                } else {
                    onmessage?.(Uint8ArrayToString(value));
                    controller.enqueue(value);
                    push(controller, reader);
                }
            };

            return fetch(url, otherParams)
                .then((response) => {
                    const reader = response.body.getReader();
                    const stream = new ReadableStream({
                        start(controller) {
                            push(controller, reader);
                        },
                    });
                    return stream;
                })
                .then((stream) => new Response(stream, { headers: { 'Content-Type': 'text/html' } }).text());
        };

        /** DOM节点 */
        const messageInput = document.getElementById('message');
        const sendFetchStreamButton = document.getElementById('fetchStream');
        var url = "https://localhost:7103/api/OpenAI/fetch"

        // 自定义封装fetch 请求
        sendFetchStreamButton.addEventListener('click', () => {
            // 创建 EventSource 对象
            const message = messageInput.value;
            fetchStream(url, {
                method: 'post',
                headers: {
                    accept: 'text/event-stream',
                    'Content-Type': 'application/json',
                },
                onmessage: (res) => {
                    //const json = parser(res);
                    console.log(res);
                    console.log("---------------");
                },
            });
        });
    </script>
</body>
</html>